# Scrapbox JSON to Markdown 変換仕様

## JSON構造

### トップレベル
- **name**: プロジェクト名
- **displayName**: 表示名
- **exported**: エクスポート日時（UNIXタイムスタンプ）
- **users**: ユーザー情報配列
- **pages**: ページ配列（各ページが1つのドキュメント）

### ページ構造
- **title**: ページタイトル
- **created**: 作成日時（UNIXタイムスタンプ）
- **updated**: 更新日時（UNIXタイムスタンプ）
- **id**: ページID
- **views**: 閲覧数
- **lines**: 行配列
  - **text**: テキスト内容
  - **created**: 作成日時
  - **updated**: 更新日時
  - **userId**: 編集者ID
- **linksLc**: リンク先（小文字）の配列

## Scrapbox記法 → Markdown変換ルール

### 変換順序（重要）
以下の順序で変換を行う必要がある：

1. **[* 太字テキスト]** → **太字テキスト**（単一アスタリスクは太字）
2. **[*** 見出しテキスト]** → # 見出しテキスト（最大アスタリスク数がH1）
3. **[** 見出しテキスト]** → ## 見出しテキスト（アスタリスク数が少ないほど下位の見出し）
4. **[/ 斜体テキスト]** → *斜体テキスト*
5. **[https://example.com/image.png]** → ![](https://example.com/image.png)（画像埋め込み）
6. **#ページ名** → [ページ名](ページ名.md)（該当ページが存在する場合のみ、存在しない場合は警告）
7. **[テキスト](https://scrapbox.io/プロジェクト/ページ)** → [テキスト](ページ.md)（同一プロジェクトの場合。ページが存在しない場合はエラー）
8. **[テキスト](ページ.md)** → そのまま（既にMarkdown形式のローカルリンク。ページが存在しない場合は警告）
9. **[リンクテキスト]** → [リンクテキスト](リンクテキスト.md)（内部リンク。最後に処理）
10. **https://example.com** → <https://example.com>（プレーンテキストURL）
11. **code:言語名** → ` ```言語名`（コードブロック開始）
12. **> 引用テキスト** → > 引用テキスト（引用ブロック）

### [リンクテキスト]パターンの処理
- これは最後に処理する必要がある（他のパターンとの競合を避けるため）
- 以下のパターンは変換しない：
  - `[* text]`、`[** text]`、`[*** text]` など（フォーマット記法）
  - `[/ text]`（斜体記法）
  - `[https://...]`（URL）
  - `[text](url)`（既にMarkdown形式）
- ページ名の解決：
  - まずそのままの名前で検索
  - 見つからない場合はスペースを`_`に変換して検索
  - それでも見つからない場合は`_`をスペースに変換して検索

### プレーンテキストURLの処理
- 文中に現れる `http://` または `https://` で始まるURLを自動的にリンクに変換
- Markdown形式: `<https://example.com>` （尖括弧で囲む）
- 既に `[text](url)` 形式や `[url]` 形式になっているものは除外
- コードブロック内のURLは変換しない

### インデント処理と他の記法の組み合わせ
- インデント（スペースで始まる行）がある場合でも、その行内の他の記法は処理される必要がある
- 処理順序：
  1. まず行全体に対してインライン記法（リンク、太字、斜体など）を処理
  2. その後、インデント/リスト変換を適用
- これにより、`  利用規約: [Terms of Use]` は `- 利用規約: [Terms of Use](Terms_of_Use.md)` に正しく変換される
12. **インデント** → リストまたはコードブロック内のインデント
    - **アスタリスクを含むリスト項目**:
      - **先頭に`*`（スペースなし）** → `- ` （リスト第1レベル）
      - **4スペース + `*`** → `  - ` （リスト第2レベル）
      - **8スペース + `*`** → `    - ` （リスト第3レベル）
      - **パターン**: N*4スペース + `*` → N*2スペース + `- `
    - **その他のインデント**:
      - **1スペース** → `- ` （リスト第1レベル）
      - **1スペース + タブ** → `  - ` （リスト第2レベル）
      - **複数スペース（コードブロック内）** → そのまま保持

### Scrapbox.io URLの処理
- 同一プロジェクトへのリンク：ローカルページへの参照として変換
- ページが存在しない場合：エラーとして処理を中断
- 他プロジェクトへのリンク：外部リンクとしてそのまま保持
- URLデコード：URLエンコードされたページ名を適切にデコード
- ページ名解決：まずそのままの名前で検索し、見つからない場合は`_`をスペースに変換して再検索

### ローカルリンクの処理
- `[テキスト](ページ.md)`形式のリンクが参照するページの存在確認
- ファイル名にスペースが含まれる場合、`_`に変換されたファイル名もチェック
- ページが存在しない場合：エラーとして処理を中断

### 見出しレベルの対応
- アスタリスクが多いほど大きな見出し（Scrapboxの仕様）
- 最大アスタリスク数（現在は3）を#（H1）に対応させる
- 例：`[***]` → `#`、`[**]` → `##`

## 変換仕様

### ファイル構成
1. 各ページを1つのMarkdownファイルに変換
2. ファイル名: `{title}.md`（特殊文字は適切にエスケープ）
3. 出力先: プロジェクト名のディレクトリ内

### Markdownファイル構造
```markdown
---
title: "ページタイトル"
created: 2021-05-30T12:00:00Z
updated: 2024-04-09T12:00:00Z
id: "ページID"
views: 123
links: ["リンク1", "リンク2"]
---

# ページタイトル

本文...
```

### 特殊な処理
1. 連続する空行は1つの空行にまとめる
2. コードブロックは言語指定を維持
3. 画像URLはそのまま保持
4. 内部リンクは相対パスで.md拡張子付きに変換
5. 外部リンクはそのまま保持